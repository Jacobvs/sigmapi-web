# Sigma Pi Gamma Iota Chapter's website

This Python Django application powers the Sigma Pi, Gamma Iota Chapter's website, which can be found at: https://sigmapigammaiota.org/

# Developer Guide

## Dependencies

* [Git](https://git-scm.com/downloads): Version control system.
  The latest version is recommended.
* [Virtualbox](https://www.virtualbox.org/wiki/Downloads): Virtualization software
  for local development. The latest version is recommended.
* [Vagrant](https://releases.hashicorp.com/vagrant/): Used to keep
  the build environment standard between developers.
  Version 1.9.7 is recommended.
* [vagrant-vbguest](https://github.com/dotless-de/vagrant-vbguest): For integration
  between Virtualbox and Vagrant. The latest version is recommended.


## First time setup

These steps will walk you through deploying the site on your local machine for the first time.

### 1. Clone the repository.

```bash
$ git clone https://github.com/sigmapi-gammaiota/sigmapi-web.git
...
$ cd sigmapi-web
```

### 2. Create the Vagrant VM.

Note that this may take a few minutes, and a lot of text will fly by.

```bash
$ vagrant up
```

### 3. Open up a shell on the virtual machine, and navigate to the shared folder.

```bash
$ vagrant ssh
```
You should land in the /vagrant/sigmapiweb/ directory but if you don't:
```bash
$ cd /vagrant/sigmapiweb
```

### 4. Set up development environment

You will only have to do this once. This installs requirements, loads initial
data for the database, and collects static files.

```bash
$ make dev
```

### 5. Run Django.

```bash
$ make run
```

### 6. Open a web browser on your computer, and navigate to localhost:8000 to view the site.

You can make changes to the code and your running instance will be updated automatically. You can log into the site with the admin account credentials you created earlier.  **NOTE:** Though changes will automatically update, JS and CSS resources will get cached and require a redownload using `ctrl-F5`

When you are done working, it is best to run `vagrant suspend` from your host (not from the VM) in order to stop the VM from running in the background. Later you can `vagrant resume` to bring the VM back to the state it was in previously.

## Deploying to WebFaction

### 1. SSH into our WebFaction box.

Credentials are redacted, contact @kdmccormick if you need them.

```bash
$ ssh our_username@our_domain.webfactional.com
```

### 2. Navigate to the deploy folder, and run the deploy script.

```bash
$ cd deploy
$ ./deploy.sh
```

Note that the `deploy.sh` script in that folder should be a copy of the one in this repository. It is kept here for version controlling.

At this point you should be *done*, unless you need to...

### 3. Rollback if necessary

There may be warnings on deploy, but if there is a failure in production after deployment then you should perform a rollback. In the same directory as the `delpoy.sh` script is `rollback.sh`, which will revert production to its previous deploy.

Note that there are additional complications if you wish to deploy a code change which requires a database migration. For now defer to @kdmccormick for that.

## Fixture Data

When you load the dev fixture data, the following users are created (along with their associated groups):

```
admin:password # The admin user.
brother:brother # A regular active brother account.
first:first # The first counselor.
second:second # The second counselor.
third:third # The third counselor.
fourth:fourth # The fourth counselor.
alumnichair:alumnichair # The alumni relations chair.
newmember:newmember # A new member.
bacchair:bacchair # The BAC chair.
housemanager:housemanager # The house manager.
parliamentarian:parliamentarian # The parliamentarian.
philanthropychair:philanthropychair # The philanthropy chair.
rushchair:rushchair # The rush chair.
sage:sage # The sage.
scholarshipchair:scholarshipchair # The scholarship chair.
socialchair:socialchair # The social chair
steward:steward # The steward.
```

### Updating Fixture Data

```bash
$ make dumpdata
```

This runs the following command:
```bash
python3 manage.py dumpdata --natural-foreign -e contenttypes -e auth.Permission > fixtures/dev_data.json
```
> --natural-foreign will use a more durable representation of foreign keys (ex. User.username instead of User.id)

> -e flags are used to exclude contenttypes and permissions, which are already generated by syncdb
